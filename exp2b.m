di=[0.000000000, -0.000015259, -0.000015259, -0.000015259, -0.000015259, -0.000015259,-0.000015259, -0.000030518, -0.000030518, -0.000030518, -0.000030518, -0.000045776,-0.000045776, -0.000061035, -0.000061035, -0.000076294, -0.000076294, -0.000091553,-0.000106812, -0.000106812, -0.000122070, -0.000137329, -0.000152588, -0.000167847,-0.000198364, -0.000213623, -0.000244141, -0.000259399, -0.000289917, -0.000320435,-0.000366211, -0.000396729, -0.000442505, -0.000473022, -0.000534058, -0.000579834,-0.000625610, -0.000686646, -0.000747681, -0.000808716, -0.000885010, -0.000961304,-0.001037598, -0.001113892, -0.001205444, -0.001296997, -0.001388550, -0.001480103,-0.001586914, -0.001693726, -0.001785278, -0.001907349, -0.002014160, -0.002120972,-0.002243042, -0.002349854, -0.002456665, -0.002578735, -0.002685547, -0.002792358,-0.002899170, -0.002990723, -0.003082275, -0.003173828,  0.003250122,  0.003326416,0.003387451,  0.003433228,  0.003463745,  0.003479004,  0.003479004,  0.003463745,0.003417969,  0.003372192,  0.003280640,  0.003173828,  0.003051758,  0.002883911,0.002700806,  0.002487183,  0.002227783,  0.001937866,  0.001617432,  0.001266479,0.000869751,  0.000442505, -0.000030518, -0.000549316, -0.001098633, -0.001693726,-0.002334595, -0.003005981, -0.003723145, -0.004486084, -0.005294800, -0.006118774,-0.007003784, -0.007919312, -0.008865356, -0.009841919, -0.010848999, -0.011886597,-0.012939453, -0.014022827, -0.015121460, -0.016235352, -0.017349243, -0.018463135,-0.019577026, -0.020690918, -0.021789551, -0.022857666, -0.023910522, -0.024932861,-0.025909424, -0.026840210, -0.027725220, -0.028533936, -0.029281616, -0.029937744,-0.030532837, -0.031005859, -0.031387329, -0.031661987, -0.031814575, -0.031845093,-0.031738281, -0.031478882,  0.031082153,  0.030517578,  0.029785156,  0.028884888,0.027801514,  0.026535034,  0.025085449,  0.023422241,  0.021575928,  0.019531250,0.017257690,  0.014801025,  0.012115479,  0.009231567,  0.006134033,  0.002822876,-0.000686646, -0.004394531, -0.008316040, -0.012420654, -0.016708374, -0.021179199,-0.025817871, -0.030609131, -0.035552979, -0.040634155, -0.045837402, -0.051132202,-0.056533813, -0.061996460, -0.067520142, -0.073059082, -0.078628540, -0.084182739,-0.089706421, -0.095169067, -0.100540161, -0.105819702, -0.110946655, -0.115921021,-0.120697021, -0.125259399, -0.129562378, -0.133590698, -0.137298584, -0.140670776,-0.143676758, -0.146255493, -0.148422241, -0.150115967, -0.151306152, -0.151962280,-0.152069092, -0.151596069, -0.150497437, -0.148773193, -0.146362305, -0.143264771,-0.139450073, -0.134887695, -0.129577637, -0.123474121, -0.116577148, -0.108856201,0.100311279,  0.090927124,  0.080688477,  0.069595337,  0.057617188,  0.044784546,0.031082153,  0.016510010,  0.001068115, -0.015228271, -0.032379150, -0.050354004,-0.069168091, -0.088775635, -0.109161377, -0.130310059, -0.152206421, -0.174789429,-0.198059082, -0.221984863, -0.246505737, -0.271591187, -0.297210693, -0.323318481,-0.349868774, -0.376800537, -0.404083252, -0.431655884, -0.459472656, -0.487472534,-0.515609741, -0.543823242, -0.572036743, -0.600219727, -0.628295898, -0.656219482,-0.683914185, -0.711318970, -0.738372803, -0.765029907, -0.791213989, -0.816864014,-0.841949463, -0.866363525, -0.890090942, -0.913055420, -0.935195923, -0.956481934,-0.976852417, -0.996246338, -1.014617920, -1.031936646, -1.048156738, -1.063217163,-1.077117920, -1.089782715, -1.101211548, -1.111373901, -1.120223999, -1.127746582,-1.133926392, -1.138763428, -1.142211914, -1.144287109,  1.144989014,  1.144287109,1.142211914,  1.138763428,  1.133926392,  1.127746582,  1.120223999,  1.111373901,1.101211548,  1.089782715,  1.077117920,  1.063217163,  1.048156738,  1.031936646,1.014617920,  0.996246338,  0.976852417,  0.956481934,  0.935195923,  0.913055420,0.890090942,  0.866363525,  0.841949463,  0.816864014,  0.791213989,  0.765029907,0.738372803,  0.711318970,  0.683914185,  0.656219482,  0.628295898,  0.600219727,0.572036743,  0.543823242,  0.515609741,  0.487472534,  0.459472656,  0.431655884,0.404083252,  0.376800537,  0.349868774,  0.323318481,  0.297210693,  0.271591187,0.246505737,  0.221984863,  0.198059082,  0.174789429,  0.152206421,  0.130310059,0.109161377,  0.088775635,  0.069168091,  0.050354004,  0.032379150,  0.015228271,-0.001068115, -0.016510010, -0.031082153, -0.044784546, -0.057617188, -0.069595337,-0.080688477, -0.090927124,  0.100311279,  0.108856201,  0.116577148,  0.123474121,0.129577637,  0.134887695,  0.139450073,  0.143264771,  0.146362305,  0.148773193,0.150497437,  0.151596069,  0.152069092,  0.151962280,  0.151306152,  0.150115967,0.148422241,  0.146255493,  0.143676758,  0.140670776,  0.137298584,  0.133590698,0.129562378,  0.125259399,  0.120697021,  0.115921021,  0.110946655,  0.105819702,0.100540161,  0.095169067,  0.089706421,  0.084182739,  0.078628540,  0.073059082,0.067520142,  0.061996460,  0.056533813,  0.051132202,  0.045837402,  0.040634155,0.035552979,  0.030609131,  0.025817871,  0.021179199,  0.016708374,  0.012420654,0.008316040,  0.004394531,  0.000686646, -0.002822876, -0.006134033, -0.009231567,-0.012115479, -0.014801025, -0.017257690, -0.019531250, -0.021575928, -0.023422241,-0.025085449, -0.026535034, -0.027801514, -0.028884888, -0.029785156, -0.030517578,0.031082153,  0.031478882,  0.031738281,  0.031845093,  0.031814575,  0.031661987,0.031387329,  0.031005859,  0.030532837,  0.029937744,  0.029281616,  0.028533936,0.027725220,  0.026840210,  0.025909424,  0.024932861,  0.023910522,  0.022857666,0.021789551,  0.020690918,  0.019577026,  0.018463135,  0.017349243,  0.016235352,0.015121460,  0.014022827,  0.012939453,  0.011886597,  0.010848999,  0.009841919,0.008865356,  0.007919312,  0.007003784,  0.006118774,  0.005294800,  0.004486084,0.003723145,  0.003005981,  0.002334595,  0.001693726,  0.001098633,  0.000549316,0.000030518, -0.000442505, -0.000869751, -0.001266479, -0.001617432, -0.001937866,-0.002227783, -0.002487183, -0.002700806, -0.002883911, -0.003051758, -0.003173828,-0.003280640, -0.003372192, -0.003417969, -0.003463745, -0.003479004, -0.003479004,-0.003463745, -0.003433228, -0.003387451, -0.003326416,  0.003250122,  0.003173828,0.003082275,  0.002990723,  0.002899170,  0.002792358,  0.002685547,  0.002578735,0.002456665,  0.002349854,  0.002243042,  0.002120972,  0.002014160,  0.001907349,0.001785278,  0.001693726,  0.001586914,  0.001480103,  0.001388550,  0.001296997,0.001205444,  0.001113892,  0.001037598,  0.000961304,  0.000885010,  0.000808716,0.000747681,  0.000686646,  0.000625610,  0.000579834,  0.000534058,  0.000473022,0.000442505,  0.000396729,  0.000366211,  0.000320435,  0.000289917,  0.000259399,0.000244141,  0.000213623,  0.000198364,  0.000167847,  0.000152588,  0.000137329,0.000122070,  0.000106812,  0.000106812,  0.000091553,  0.000076294,  0.000076294,0.000061035,  0.000061035,  0.000045776,  0.000045776,  0.000030518,  0.000030518,0.000030518,  0.000030518,  0.000015259,  0.000015259,  0.000015259,  0.000015259,0.000015259,  0.000015259];
ci=di/32;

[x,fs]=audioread('music16khz.wav');

n = 0:(numel(ci)-1); % Generating indices starting from 0 to 511
sign_pattern = (-1).^floor(n / 64); % Computing the alternating sign pattern
p = sign_pattern .* ci; % Element-wise multiplication with ci to get p

M = 64; % Number of signals
N = length(x); % Input signal length

%ith row of delayed_signals contains x*z^-i
delayed_signals = zeros(M, N + M - 1);

for i = 0:M-1
    delayed_signals(i+1, :) = [zeros(1, i), x.', zeros(1, M-1-i)];
end

downsampled_signals = cell(M, 1); %Using a cell array to hold downsampled rows of varying length

%Downsample each row and store in the cell array
for i = 1:M
    downsampled_row = downsample(delayed_signals(i, :), 32);
    downsampled_signals{i} = downsampled_row; % Store downsampled row
end

%Find the maximum length of the downsampled rows
max_len = max(cellfun(@length, downsampled_signals));

%Preallocate the final matrix with the maximum downsampled length
downsampled_signals_matrix = zeros(M, max_len);

for i = 1:M
    row_len = length(downsampled_signals{i});
    downsampled_signals_matrix(i, 1:row_len) = downsampled_signals{i}; %Assigning the row and pad with zeros
end

%%splitting p into polyphase components

%Ensuring the length of p is a multiple of 64 by padding zeros if necessary 
p_len = length(p);
remainder = mod(p_len, M); %M=64
if remainder ~= 0
    p = [p, zeros(1, M - remainder)]; %Padding zeros
end

%Performing polyphase decomposition using reshape function
L = length(p) / M; %Length of each phase
polyphase_matrix = reshape(p, M, L);

%Each row of polyphase_matrix corresponds to one polyphase component

%shifting by pi in time domain, multiplying by (-1)^n

% Generate the (-1)^n sequence 
n = 0:7;
sequence = (-1).^n; % Sequence: [1, -1, 1, -1, 1, -1, 1, -1]

% Expand sequence to match dimensions of polyphase_matrix
sequence_repeated = repmat(sequence, M, 1); % Repeat for M rows

% Multiply each row of the polyphase matrix element-wise with the sequence
modified_polyphase_matrix = polyphase_matrix .* sequence_repeated;


%upsampling each row by 2

[M, N]=size(modified_polyphase_matrix); %M = number of rows, N = number of cols

%Upsampling factor
L=2;

%Preallocate the upsampled matrix
upsampled_matrix = zeros(M, N * L);

%insert zeros between elements for upsampling
for i = 1:M
    upsampled_matrix(i, :) = upsample(modified_polyphase_matrix(i, :), L);
end

yi = cell(M, 1); %using a cell array since the lengths of convolved outputs may vary.

%performing convolution row by row
for i = 1:M
    %convolve row i of downsampled_signals_matrix with row i of upsampled_matrix
    yi{i} = conv(downsampled_signals_matrix(i, :), upsampled_matrix(i, :));
end

%finding the maximum length of the convolved rows
max_len = max(cellfun(@length, yi));

%preallocating a padded matrix
yi_padded = zeros(M, max_len);

%filling in the rows with zero-padded convolution results
for i = 1:M
    yi_padded(i, 1:length(yi{i})) = yi{i};
end

K=32; %num of rows in matrix T (k varies from 0:31)
I=64; %num of cols in matrix T (i varies from 0:63)

%constructing matrix T (32 x 64)

T=zeros(K, I);
for k = 0:K-1
    for i = 0:I-1
        T(k+1, i+1) = cos(((2*k + 1) * i * pi) / 64 - (2*k + 1) * pi / 4);
    end
end

vd=T*yi_padded;

%%synthesis filter

%constructing matrix N 64x32

I = 64; %num of rows (0:63)
K = 32; %num of columns (0:31)
N = zeros(I, K); %preallocating the matrix

for i = 0:I-1
    for k = 0:K-1
        N(i+1, k+1) = cos(((2*k + 1) * i * pi) / 64 + (2*k + 1) * pi / 4);
    end
end


%constructing matrix Q
%upsampled_matrix contains Pi(-z^2)

[rows, cols] = size(upsampled_matrix);

%initialising the Q matrix as a 64x32 matrix of zeros
Q = zeros(64, 32, cols + 1); %Adding 1 to cols for an extra zero element when we pad upper half

%filling the upper half (first 32 rows of Q)
for i = 1:32
    temp = [upsampled_matrix(i, :), 0]; %appending a zero at the end
    for j = 1:32
        if i == j
            Q(i, j, :) = temp; %assign the vector to Q(i, j)
        else
            Q(i, j, :) = zeros(1, cols + 1); %assign a zero vector
        end
    end
end

%filling the lower half (rows 33 to 64)
for i = 1:32
    temp = [0, upsampled_matrix(32 + i, :)]; %prepend a zero for time shift (z^-1)
    for j = 1:32
        if i == j
            Q(32 + i, j, :) = temp; %assign the vector to Q(32 + i, j)
        else
            Q(32 + i, j, :) = zeros(1, cols + 1); %assign a zero vector
        end
    end
end


Q = Q * 32; %32Q
Q = permute(Q, [2, 1, 3]); %transpose along the first two dimensions (64x32 becomes 32x64)
%Q is now 32*Q_transpose

alt_fz = zeros(32, 32, cols + 1); 

for i = 1:32
    for j = 1:32
        %computing the dot product of the i-th row of Q and j-th column of T
        for k = 1:64
            alt_fz(i, j,:) = alt_fz(i, j,:) + Q(i, k,:) * N(k, j);
        end
    end
end

%ensuring that the dimensions match
conv_len = size(alt_fz, 3) + size(vd, 2) - 1;

%initialising the result matrix to hold the convolution results
s = zeros(32, conv_len);

%performing the convolution and accumulation, outputs in matrix s
for i = 1:32
    for j = 1:32
        %performing convolution and accumalating the result in s(i,:)
        s(i,:) = s(i,:) + conv(squeeze(alt_fz(i, j, :)), vd(j,:));
    end
end


%initialising the matrix s_up (to store upsampled signals of s)
%for delaying by 
s_up = zeros(32, 32 * size(s, 2));  

% Loop over each row of s
for i = 1:32
    %upsample the i-th row of s by 32
    upsampled_row = upsample(s(i,:), 32);
    
    %Apllying padding to the upsampled row
    %Row i should be padded with (i-1) zeros at the beginning and (32-i) zeros at the end
    padding_start = i - 1;
    padding_end = 32 - i;
    
    %shifting the upsampled row and set the required padding at the beginning and end
    s_up(i, :) = circshift(upsampled_row, padding_start);  %shifting the row
    s_up(i, 1:padding_start) = 0;  %adding zeros at the beginning
    s_up(i, end-padding_end+1:end) = 0;  %adding zeros at the end
end

y=sum(s_up, 1); %summing the output of commutator to get output signal y
y=y; 


%plotting
N_x = length(x);  
f_x = linspace(-pi, pi, N_x); 
X = fft(x); 
X_magnitude = abs(fftshift(X)); 
N_y = length(y); 
f_y = linspace(-pi, pi, N_y);
Y = fft(y); 
Y_magnitude = abs(fftshift(Y));  

figure;

%Magnitude spectrum of the input signal x
subplot(2, 1, 1);
plot(f_x, X_magnitude);
title('Magnitude spectrum of original input signal x');
xlabel('Frequency (rad/sample)');
ylabel('Magnitude');
xlim([-pi pi]);  
xticks(-pi:pi/2:pi); 
xticklabels({'-\pi', '-\pi/2', '0', '\pi/2', '\pi'}); 
grid on;

%Magnitude spectrum of the output signal y
subplot(2, 1, 2);
plot(f_y, Y_magnitude);
title('Magnitude spectrum of output signal y');
xlabel('Frequency (rad/sample)');
ylabel('Magnitude');
xlim([-pi pi]);
xticks(-pi:pi/2:pi);
xticklabels({'-\pi', '-\pi/2', '0', '\pi/2', '\pi'});
grid on;

